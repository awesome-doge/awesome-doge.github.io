<!DOCTYPE html>
<html>
  <head>
    <title>閃電網路筆記 – awesome-doge – Freedom is priceless.</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="
" />
    <meta property="og:description" content="
" />
    
    <meta name="author" content="awesome-doge" />

    
    <meta property="og:title" content="閃電網路筆記" />
    <meta property="twitter:title" content="閃電網路筆記" />
    
    
    
    <meta property="og:image" content="https://awesome-doge.github.io/image/ln.jpg">
    
    
    
    <meta content="" property="og:description">
    

    
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>閃電網路筆記 | awesome doge</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="閃電網路筆記" />
<meta name="author" content="awesome-doge" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Freedom is priceless." />
<meta property="og:description" content="Freedom is priceless." />
<link rel="canonical" href="https://awesome-doge.github.io/%E9%96%83%E9%9B%BB%E7%B6%B2%E8%B7%AF%E7%AD%86%E8%A8%98/" />
<meta property="og:url" content="https://awesome-doge.github.io/%E9%96%83%E9%9B%BB%E7%B6%B2%E8%B7%AF%E7%AD%86%E8%A8%98/" />
<meta property="og:site_name" content="awesome doge" />
<meta property="og:image" content="https://awesome-doge.github.io/image/ln.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-10-10T00:00:00+00:00" />
<meta name="twitter:card" content="Cypherpunks" />
<meta property="twitter:image" content="https://awesome-doge.github.io/image/ln.jpg" />
<meta property="twitter:title" content="閃電網路筆記" />
<meta name="twitter:site" content="@awesome-doge" />
<meta name="twitter:creator" content="@awesome-doge" />
<script type="application/ld+json">
{"description":"Freedom is priceless.","headline":"閃電網路筆記","dateModified":"2020-10-10T00:00:00+00:00","datePublished":"2020-10-10T00:00:00+00:00","url":"https://awesome-doge.github.io/%E9%96%83%E9%9B%BB%E7%B6%B2%E8%B7%AF%E7%AD%86%E8%A8%98/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://awesome-doge.github.io/%E9%96%83%E9%9B%BB%E7%B6%B2%E8%B7%AF%E7%AD%86%E8%A8%98/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://awesome-doge.github.io/images/doge.png"},"name":"awesome-doge"},"author":{"@type":"Person","name":"awesome-doge"},"image":"https://awesome-doge.github.io/image/ln.jpg","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="awesome-doge - Freedom is priceless." href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->

  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="/images/doge.png" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">awesome-doge</a></h1>
            <p class="site-description">Freedom is priceless.</p>
          </div>

          <nav>
            <a href="/">Blog</a>
            <a href="/post">Post</a>
            <!-- <a href="/categories">主題</a> -->
            <a href="/tor">Tor</a>
            <a href="/archive">Archives</a>
            <a href="/about">About</a>            
            <!-- <a href="/tags">tags</a> -->
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>閃電網路筆記</h1>

  <div class="entry">
    <p><img src="/image/ln.jpg" alt="" /></p>

<p>重要文獻：</p>

<ul>
  <li><a href="https://lightning.network/lightning-network-paper.pdf">閃電網路白皮書</a></li>
  <li><a href="https://github.com/cypherpunks-core/lightning_network_whitepaper_zh">閃電網路白皮書-中文版</a></li>
  <li><a href="https://lightning.engineering/technology.html">Lightning Labs</a></li>
  <li><a href="https://lightning.network/">Lightning Network</a></li>
  <li><a href="https://github.com/ElementsProject/lightning">c-lightning  技術文件</a></li>
  <li><a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/00-introduction.md">BOLT規範</a></li>
  <li><a href="https://github.com/bcongdon/awesome-lightning-network">bcongdon/awesome-lightning-network</a></li>
  <li><a href="https://blockstream.com/2018/04/30/en-eltoo-next-lightning/">eltoo: A Simplified Update Mechanism for Lightning and Off-Chain Contracts</a>
    <ul>
      <li><a href="https://blockstream.com/eltoo.pdf">eltoo: A Simple Layer2 Protocol for Bitcoin</a></li>
    </ul>
  </li>
</ul>

<hr />

<p><strong>特色活動</strong></p>
<ul>
  <li><a href="https://www.takethetorch.online/Torch">閃電網路聖火</a></li>
  <li><a href="https://bluewallet.io/marketplace/">bluewallet-marketplace</a></li>
</ul>

<hr />

<h2 id="1-比特幣的交易問題">1. 比特幣的交易問題</h2>

<hr />

<ul>
  <li>不適合micropayment
    <ul>
      <li>交易速度慢 7/tps 既使segwit 擴容 也進步很少
        <ul>
          <li>區塊大小限製 (預防中心化)</li>
          <li>挖礦/共識演算法限製 (預防分岔)</li>
        </ul>
      </li>
      <li>手續費高</li>
      <li>無法擴展</li>
    </ul>
  </li>
  <li>交易加速的解決方案
    <ul>
      <li>SQL #中心化</li>
      <li>sidechain #要有人做出來, 有人用, 中心化</li>
      <li>交易通道</li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="2-多重簽名">2. 多重簽名</h2>

<hr />

<h3 id="21-p2ms">2.1 P2MS</h3>
<p><strong>BIP 11 : P2MS-多重簽名</strong></p>
<ul>
  <li>提案時間：2011年10月18日</li>
  <li>實施時間：2012年1月</li>
  <li>缺點：
    <ul>
      <li>沒有明確的 交易地址。</li>
      <li>市佔率不到 1% , 跟報廢差不多。</li>
      <li>鎖定腳本含多個public key 相當站交易空間，被鎖死最多3-of-3。</li>
    </ul>
  </li>
</ul>

<hr />

<ul>
  <li>變動：將Tx scriptSigs 200byte 提升為500byte ，才塞得下3個簽名。</li>
  <li>錯誤：使用解鎖腳本出現問題。</li>
  <li>鎖定腳本 m-of-n：
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  m {pubkey}...{pubkey} n OP_CHECKMULTISIG 
</code></pre></div>    </div>

    <p><strong>2 - of - 2：</strong><br />
  類型：資產保戶服務：</p>
    <ul>
      <li>Key 分配：A key 為用戶自己；B key 為資產保護公司。</li>
      <li>場景：用戶 付錢的同時，需要經過 資產保護公司 同意。</li>
      <li>缺點：資產保護公司 跑路啥都沒了。</li>
    </ul>

    <p><strong>2 - of - 3:</strong><br />
  類型：線上拍賣平臺：</p>
    <ul>
      <li>Key 分配：A key 為買家；B key 為賣家；c key 仲裁第三方。</li>
      <li>場景：用戶購物時，先把錢存入2 - of - 3地址。。</li>
      <li>交易成功：買家 &amp; 賣家簽名。</li>
      <li>交易爭議：買家 ＆ 仲裁第三方 or 賣家 ＆ 仲裁第三方。</li>
    </ul>
  </li>
</ul>

<hr />

<h3 id="22-p2sh">2.2. P2SH</h3>

<hr />
<p><strong>BIP 13 P2SH - 多重簽名地址(定義3開頭地址)</strong></p>
<ul>
  <li>實施時間：2012年4月</li>
  <li>特色：
    <ul>
      <li>Redeem script 取代 p2ms data</li>
      <li>有明確的地址</li>
      <li>複雜的部分由接收方處理</li>
      <li>使用3 開頭地址承擔交易費用</li>
      <li>存儲空間由下一個人承擔</li>
    </ul>
  </li>
</ul>

<hr />

<table>
  <thead>
    <tr>
      <th>字首</th>
      <th>鎖定腳本</th>
      <th>地址首字</th>
      <th>範例地址</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>00</td>
      <td>P2PKH</td>
      <td>1</td>
      <td>1AKDDsfTh8uY4X3ppy1m7jw1fVMBSMkzjP</td>
    </tr>
    <tr>
      <td>05</td>
      <td>P2SH</td>
      <td>3</td>
      <td>34nSkinWC9rDDJiUY438qQN1JHmGqBHGW7</td>
    </tr>
    <tr>
      <td>6F</td>
      <td>P2PKH（測試網）</td>
      <td>m/ n</td>
      <td>ms2qxPw1Q2nTkm4eMHqe6mM7JAFqAwDhpB</td>
    </tr>
    <tr>
      <td>C4</td>
      <td>P2SH（測試網）</td>
      <td>2</td>
      <td>2MwSNRexxm3uhAKF696xq3ztdiqgMj36rJo</td>
    </tr>
  </tbody>
</table>

<hr />

<h4 id="bip-16-p2sh-多重簽名-定義redeam-script">BIP 16 P2SH-多重簽名 (定義redeam script)</h4>

<hr />

<h3 id="23-segwit">2.3. Segwit</h3>
<p>SegWit 特色 :</p>
<ul>
  <li>解決 p2pk, p2pkh, p2ms, p2sh. 交易問題 - 交易延展性問題</li>
  <li>將區塊大小改為 Weights 計算</li>
  <li>將區塊大小由 Max 1MB 擴容到 1.8MB</li>
  <li>降低 Tx 簽名 的 Weights ，使 SegWit 交易可以打將近七摺的手續費</li>
  <li>添加 wp2pkh, wp2sh 並且加入交易版本號概念，未來可以升級</li>
</ul>

<hr />

<p><strong>BIP 141 : 對於SegWit 做出廣泛的定義</strong><br />
<strong>BIP 142 : 舊的SegWit 地址定義，已經被BIP 173 Bech32的地址取代</strong><br />
<strong>BIP 143 :</strong></p>
<ul>
  <li>添加交易版本號，到交易當中</li>
  <li>定義新的交易驗證流成: wp2pkh, wp2sh</li>
</ul>

<p><strong>BIP 144 : 定義執持SegWit的p2p網路</strong><br />
<strong>BIP 145 : 定義SegWit網路中的getblock</strong><br />
<strong>BIP 173 : 定義SegWit地址格式</strong></p>
<ul>
  <li>Bech32解決過去p2pkh p2sh的問題：
    <ul>
      <li>Base 58 佔用 QR code 太多空間</li>
      <li>語音讀出時無法辨識大小寫</li>
      <li>Double-SHA256 效能低，且沒有 錯誤檢測(error-decetion)功能</li>
      <li>Base58 無法採用 錯誤檢測(error-decetion) ，因為要基於 prime-power</li>
      <li>Base58 比較複雜 ，且相對較慢</li>
    </ul>

    <p><img src="https://i.imgur.com/qQDnrMw.png" alt="" /></p>
  </li>
</ul>

<h2 id="3-時間鎖">3. 時間鎖</h2>

<ul>
  <li>nLockTime：off-chain 絕對時間鎖 UNIX/block
    <ul>
      <li>提案者：中本聰 bitcoin 0.1</li>
      <li>狀況：今年年初 nLockTime 設置為 0 僅為 20 %</li>
    </ul>
  </li>
  <li>CheckLockTimeVerify（CLTV)：on-chain 絕對時間鎖(nLockTime格式) UNIX/block
    <ul>
      <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki#Escrow">BIP65 - OP_CHECKLOCKTIMEVERIFY</a>
        <ul>
          <li>new opcode：OP_CHECKLOCKTIMEVERIFY（CLTV）</li>
          <li>功能：讓資金在未來的某個時間點可以可以被某人使用</li>
        </ul>
      </li>
      <li>場景：
        <ul>
          <li>第三方託管｜Escrow
  Lenny 經過 3 個月後，Alice 或 Bob 中的一個可以用以下 OPCode 支付資金
            <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      IF
          &lt;now + 3 months&gt; CHECKLOCKTIMEVERIFY DROP
          &lt;Lenny's pubkey&gt; CHECKSIGVERIFY
          1
      ELSE
          2
      ENDIF
      &lt;Alice's pubkey&gt; &lt;Bob's pubkey&gt; 2 CHECKMULTISIG
</code></pre></div>            </div>
          </li>
          <li>雙因素錢包｜非交互式定期退款｜Non-interactive time-locked refunds
            <ul>
              <li>雙因素錢包 | Two-factor wallets
                <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  IF
      &lt;service pubkey&gt; CHECKSIGVERIFY
  ELSE
      &lt;expiry time&gt; CHECKLOCKTIMEVERIFY DROP
  ENDIF
  &lt;user pubkey&gt; CHECKSIG
</code></pre></div>                </div>
              </li>
              <li>Payment Channels = CLTV style channel</li>
            </ul>
          </li>
          <li>Trustless Payments for Publishing Data
            <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  IF
      HASH160 &lt;Hash160(encryption key)&gt; EQUALVERIFY
      &lt;publisher pubkey&gt; CHECKSIG
  ELSE
      &lt;expiry time&gt; CHECKLOCKTIMEVERIFY DROP
      &lt;buyer pubkey&gt; CHECKSIG
  ENDIF
</code></pre></div>            </div>
          </li>
          <li>Proving sacrifice to miners’ fees</li>
          <li>凍結資金 | Freezing Funds
            <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  &lt;expiry time&gt; CHECKLOCKTIMEVERIFY DROP DUP HASH160 &lt;pubKeyHash&gt; EQUALVERIFY CHECKSIG
</code></pre></div>            </div>
          </li>
          <li>Replacing the nLockTime field entirely</li>
        </ul>
      </li>
      <li>實現 CLTV 單嚮通道
        <ul>
          <li>缺點：
            <ul>
              <li>有壽命</li>
              <li>要等待退款</li>
              <li>單嚮</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Relative locktime (RLT)(相對時間 - on chain)
    <ul>
      <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki">BIP68 - Relative lock-time using consensus-enforced sequence numbers</a>
        <ul>
          <li>提出：nsequence 時間格式
  <img src="https://i.imgur.com/ow19rOq.png" alt="" /></li>
        </ul>
      </li>
      <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki">BIP112 - CHECKSEQUENCEVERIFY</a>
        <ul>
          <li>new opcode：CHECKSEQUENCEVERIFY(CSV)</li>
          <li>功能：搭配 nsequence 解鎖</li>
          <li>場景：
            <ul>
              <li>Escrow with Timeout
                <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  IF
      2 &lt;Alice's pubkey&gt; &lt;Bob's pubkey&gt; &lt;Escrow's pubkey&gt; 3 CHECKMULTISIG
  ELSE
      "30d" CHECKSEQUENCEVERIFY DROP
      &lt;Alice's pubkey&gt; CHECKSIG
  ENDIF
</code></pre></div>                </div>
              </li>
              <li>Retroactive Invalidation</li>
              <li>Hash Time-Locked Contracts</li>
              <li>Bidirectional Payment Channels</li>
              <li>Lightning Network
                <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  HASH160 &lt;revokehash&gt; EQUAL
  IF
      &lt;Bob's pubkey&gt;
  ELSE
      "24h" CHECKSEQUENCEVERIFY DROP
      &lt;Alice's pubkey&gt;
  ENDIF
  CHECKSIG
</code></pre></div>                </div>
                <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  HASH160 &lt;revokehash&gt; EQUAL
  IF
      &lt;Bob's pubkey&gt;
  ELSE
      "2015/12/15" CHECKLOCKTIMEVERIFY DROP
      &lt;Alice's pubkey&gt;
  ENDIF
  CHECKSIG
</code></pre></div>                </div>
                <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  HASH160 DUP &lt;R-HASH&gt; EQUAL
  IF
      "24h" CHECKSEQUENCEVERIFY
      2DROP
      &lt;Alice's pubkey&gt;
  ELSE
      &lt;Commit-Revocation-Hash&gt; EQUAL
      NOTIF
          "2015/10/20 10:33" CHECKLOCKTIMEVERIFY DROP
      ENDIF
      &lt;Bob's pubkey&gt;
  ENDIF
  CHECKSIG
</code></pre></div>                </div>
                <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> HASH160 DUP &lt;R-HASH&gt; EQUAL
 SWAP &lt;Commit-Revocation-Hash&gt; EQUAL ADD
 IF
     &lt;Alice's pubkey&gt;
 ELSE
     "2015/10/20 10:33" CHECKLOCKTIMEVERIFY
     "24h" CHECKSEQUENCEVERIFY
     2DROP
     &lt;Bob's pubkey&gt;
 ENDIF
 CHECKSIG
</code></pre></div>                </div>
              </li>
              <li>2-Way Pegged Sidechains</li>
            </ul>

            <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      IF
          lockTxHeight &lt;lockTxHash&gt; nlocktxOut [&lt;workAmount&gt;] reorgBounty Hash160(&lt;...&gt;) &lt;genesisHash&gt; REORGPROOFVERIFY
      ELSE
          withdrawLockTime CHECKSEQUENCEVERIFY DROP HASH160 p2shWithdrawDest EQUAL
      ENDIF
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li>BIP113
        <ul>
          <li>功能：定義新的去中心化時間</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="https://medium.com/summa-technology/bitcoins-time-locks-27e0c362d7a1">Bitcoin’s Time Locks</a></li>
</ul>

<h2 id="4-交易延展性問題">4. <a href="https://en.bitcoin.it/wiki/Transaction_malleability">交易延展性問題</a></h2>

<ul>
  <li>BIP 62(x)：提出了九種交易延展性問題 <a href="https://en.bitcoin.it/wiki/BIP_0062">link</a></li>
  <li>BIP 66(O): 強製執行DER編碼<a href="https://github.com/bitcoin/bips/blob/master/bip-0066.mediawiki">link</a></li>
  <li>SegWit(O)</li>
</ul>

<h2 id="5-交易通道的演進">5. 交易通道的演進</h2>
<ul>
  <li>交易通道的演進 <a href="https://en.bitcoin.it/wiki/Payment_channels">bitcoin.wiki</a>
    <ol>
      <li>Nakamoto high-frequency transactions(nSequence+nLockTime)
        <blockquote>
          <p>提出日期：bitcoin  0.1
缺點: 可以串通礦工 一起決定最終版本</p>
        </blockquote>
      </li>
    </ol>
  </li>
</ul>

<ol>
  <li>Spillman-style payment channels
    <blockquote>
      <p>提出日期：2013年4月20日 <br />
提出作者：Peter Todd <br />
實現：BitcoinJ  <a href="https://bitcointalk.org/index.php?topic=244656.0">bitcointalk</a>  , <a href="https://bitcoin.org/en/contracts-guide#micropayment-channel">bitcoin.org</a>
機製：nlocktime 讓礦工無法打包交易 <br />
詳細過程：<a href="https://en.bitcoin.it/wiki/Contract#Example_7:_Rapidly-adjusted_.28micro.29payments_to_a_pre-determined_party">bitcoin.wiki</a> <br />
特色：</p>
      <ul>
        <li>單嚮支付通道</li>
        <li>特定時間到期(nSequence)
 缺點：</li>
        <li>無法抵擋交易延展性攻擊</li>
        <li>資金無法原路返回</li>
      </ul>
    </blockquote>
  </li>
  <li>CLTV-style payment channels
    <blockquote>
      <p>提出日期：2014年10月1日<br />
 提出：BIP 65 鎖定$到未來 (O) <a href="https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki#Payment_Channels">bip</a>
特色：</p>
      <ul>
        <li>單嚮支付通道</li>
        <li>特定時間到期</li>
      </ul>
    </blockquote>

    <blockquote>
      <p>優點：</p>
      <ul>
        <li>抵抗<strong>Spillman-style payment channels</strong>交易延展性問題(前提依賴 新的OP_CLTV 軟分叉)</li>
      </ul>
    </blockquote>
  </li>
  <li>Poon-Dryja payment channels <strong>閃電網路BOLT3採用</strong>
    <blockquote>
      <p>提出日期：2016年4月10日 <br />
 提出作者：Joseph Poon, Thaddeus Dryja[lightning.network]
 論文：<a href="https://lightning.network/lightning-network-paper.pdf">The Bitcoin Lightning Network:
Scalable Off-Chain Instant Payments</a> <br />
 特色：
     &gt;  * 雙嚮
     &gt;  * 沒有期限</p>
    </blockquote>
  </li>
  <li>Decker-Wattenhofer duplex payment channels
    <blockquote>
      <p>提出：2015年8月4日<br />
提出單位：Distributed Computing Group, ETH Zurich
論文：<a href="https://tik-old.ee.ethz.ch/file/716b955c130e6c703fac336ea17b1670/duplex-micropayment-channels.pdf">A Fast and Scalable Payment Network with
Bitcoin Duplex Micropayment Channels</a></p>
      <ul>
        <li>依賴 BIP 68 相對時間鎖(O)</li>
        <li>由<strong>兩個單嚮(Spillman-nSequence)支付通道</strong>組成</li>
      </ul>
    </blockquote>
  </li>
  <li>Decker-Russell-Osuntokun eltoo Channels
    <blockquote>
      <p>提出時間：2018年5月2日<br />
提出作者：Christian Decker,Rusty Russell[Blockstream], Olaoluwa Osuntokun[Lightning Labs]<br />
論文：<a href="https://blockstream.com/eltoo.pdf">eltoo: A Simple Layer2 Protocol for Bitcoin</a></p>
    </blockquote>
  </li>
  <li>Hashed Time-Locked Contracts (HTLCs)</li>
  <li>Reahing The Ground With Lightning
    <blockquote>
      <p>論文：<a href="https://github.com/ElementsProject/lightning/blob/master/doc/deployable-lightning.pdf">Reahing The Ground With Lightning</a></p>
    </blockquote>
  </li>
</ol>

<h2 id="6-輕量級節點">6. 輕量級節點</h2>

<h2 id="7-閃電網路搭建問題">7. 閃電網路搭建&amp;問題</h2>
<h3 id="71-單嚮通道">7.1. 單嚮通道</h3>
<ul>
  <li>過程
    <ul>
      <li>A &amp; B 創建一個 wp2sh-address-AB</li>
      <li>A 把錢丟進去 (保證金交易（Funding Transaction）) #預防B跑路拿不到錢</li>
      <li>設定一個 nlocktime 把 A的錢 在未來的某個時間點 打款給自己</li>
      <li>開始刷新交易….天荒地老…</li>
      <li>廣播最後一筆紀錄</li>
    </ul>
  </li>
  <li>缺點
    <ul>
      <li>單嚮</li>
      <li>要等到nlocktime 才可以贖回</li>
    </ul>
  </li>
</ul>

<h3 id="72-rsmc全稱revocable-sequence-maturity-contract">7.2. RSMC，全稱Revocable Sequence Maturity Contract</h3>
<p>可撤銷的相對時間鎖合約 <a href="https://blocking.net/1516/bitcoin-lightning-network-rsmc/">Bitcoin Lightning Network: RSMC
</a></p>
<blockquote>
  <p>押金交易 - Funding Tx
承諾交易 - Commitment Tx</p>
</blockquote>

<ul>
  <li>過程
    <ul>
      <li>生成wp2sh 地址</li>
      <li>雙方掏錢 打錢進去-保證金交易(Funding Transaction）
<img src="https://i.imgur.com/4rM0UNm.png" alt="" /></li>
      <li>設定退款，雙方壓多少 退多少
        <ul>
          <li>交易結構
            <ul>
              <li>Ａ的
                <ul>
                  <li>承諾交易</li>
                  <li>退款金額</li>
                </ul>
              </li>
              <li>B 的
                <ul>
                  <li>承諾交易</li>
                  <li>退款金額 
<img src="https://i.imgur.com/i5xRAS2.png" alt="" />
                    <blockquote>
                      <ul>
                        <li>每交易一次，四個狀態刷新，舊的狀態廢除</li>
                        <li>關閉通道的 sequence 為 0</li>
                        <li>要完成 承諾交易 才可以釋出 funding 交易</li>
                      </ul>
                    </blockquote>
                  </li>
                </ul>
              </li>
            </ul>

            <p><img src="https://i.imgur.com/7yniM8Z.png" alt="" /></p>
          </li>
          <li>違約 (A違約)
            <ul>
              <li>交易結構
                <ul>
                  <li>Ａ的
                    <ul>
                      <li>承諾交易(O)-&gt;B<sub>1</sub> 立刻領到錢</li>
                      <li>退款金額(O)-&gt;Ａ<sub>2</sub>&amp;B<sub>1</sub> (sequence)收錢，要等sequence 一段時間做為逞罰</li>
                    </ul>
                  </li>
                  <li>B 的
                    <ul>
                      <li>承諾交易(x)-&gt;A<sub>1</sub></li>
                      <li>退款金額(x)-&gt;Ａ<sub>1</sub>&amp;B<sub>2</sub> (sequence)</li>
                    </ul>
                  </li>
                </ul>
              </li>
            </ul>
          </li>
          <li>交易結構 (逞罰機製)
            <ul>
              <li>Ａ的
                <ul>
                  <li>承諾交易-&gt;B<sub>1</sub> 立刻領到錢</li>
                  <li>退款金額-&gt;Ａ<sub>2</sub>&amp;B<sub>1</sub> (sequence)</li>
                  <li>逞罰交易 取得B<sub>1</sub>私鑰 ，拿Ａ<sub>2</sub>簽</li>
                </ul>
              </li>
              <li>B 的
                <ul>
                  <li>承諾交易-&gt;A<sub>1</sub></li>
                  <li>退款金額-&gt;Ａ<sub>1</sub>&amp;B<sub>2</sub> (sequence)</li>
                  <li>逞罰交易 取得A<sub>1</sub>私鑰 ，拿B<sub>2</sub>簽
<img src="https://i.imgur.com/b5hcRDV.png" alt="" /></li>
                </ul>
              </li>
            </ul>

            <blockquote>
              <ul>
                <li>如果 A 反悔 廣播 承諾交易-&gt;B、退款金額-&gt;Ａ(sequence)</li>
                <li>B 發起 逞罰交易 會贏 因為 Ａ還要等sequence</li>
                <li>舊的交易才會有 逞罰交易（偵防塔 應該就存這些</li>
                <li>逞罰機製 私鑰天上傳無所謂</li>
              </ul>
            </blockquote>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>特色
    <ul>
      <li>雙嚮</li>
      <li>不需要等待贖回時間</li>
      <li>保證雙方都不作惡</li>
    </ul>
  </li>
</ul>

<h3 id="73-htlc-哈希時間所合約">7.3. HTLC 哈希時間所合約</h3>

<h3 id="問題">問題</h3>
<ul>
  <li>路由
    <ul>
      <li>在中繼的過程中有人吃錢</li>
      <li>最佳路徑
        <ul>
          <li>快速</li>
          <li>穩定</li>
          <li>便宜</li>
        </ul>
      </li>
      <li>路由延遲</li>
      <li>殭屍節點</li>
    </ul>
  </li>
  <li>押金
    <ul>
      <li>一般用戶
        <ul>
          <li>最佳化押金，可以好好付錢，autopilot</li>
        </ul>
      </li>
      <li>運營商
        <ul>
          <li>計算押金部署的投資報酬</li>
          <li>計算動態手續費</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>雙方在線
    <ul>
      <li>麻煩</li>
      <li>危險</li>
    </ul>
  </li>
  <li>有壞人
    <ul>
      <li>偵防塔
        <ul>
          <li>客戶端</li>
          <li>伺服器端
            <h2 id="8-開發">8. 開發</h2>
            <p><strong>Basis of Lightning Technology (BOLT)</strong></p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/00-introduction.md">BOLT #0: Introduction and Index</a></li>
  <li><a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/01-messaging.md">BOLT #1: Base Protocol</a></li>
  <li><a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md">BOLT #2: Peer Protocol for Channel Management</a></li>
  <li><a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/03-transactions.md">BOLT #3: Bitcoin Transaction and Script Formats</a></li>
  <li><a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/04-onion-routing.md">BOLT #4: Onion Routing Protocol</a></li>
  <li><a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/05-onchain.md">BOLT #5: Recommendations for On-chain Transaction Handling</a></li>
  <li><a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/07-routing-gossip.md">BOLT #7: P2P Node and Channel Discovery</a></li>
  <li><a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/08-transport.md">BOLT #8: Encrypted and Authenticated Transport</a></li>
  <li><a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/09-features.md">BOLT #9: Assigned Feature Flags</a></li>
  <li><a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/10-dns-bootstrap.md">BOLT #10: DNS Bootstrap and Assisted Node Location</a></li>
  <li><a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/11-payment-encoding.md">BOLT #11: Invoice Protocol for Lightning Payments</a></li>
</ul>

<p><strong>library</strong></p>
<ul>
  <li><strong><a href="https://github.com/lightningnetwork/lnd">lightningnetwork/lnd</a> - Lightning Network Daemon（lnd） - 是Lightning Network節點的完整實現。(Golang)</strong></li>
  <li><strong><a href="https://github.com/ElementsProject/lightning">ElementsProject/lightning</a> - c-lightning：C語言中符合規範的Lightning Network實現(C)</strong></li>
  <li><strong><a href="https://github.com/ACINQ/eclair">ACINQ/eclair</a> - Lightning Network的Scala語言實現。它可以在有或沒有GUI的情況下運行，也可以使用JSON-RPC API。(Scala)</strong></li>
  <li><a href="https://github.com/mit-dci/lit">mit-dci/lit</a> - Lightning Network節點軟件(Golang)</li>
  <li><a href="https://github.com/lightningnetwork/lightning-onion">lightningnetwork/lightning-onion</a> - 該存儲庫包含Lightning Network的洋蔥路由協議的實現。(Golang)</li>
  <li><a href="https://github.com/nayutaco/ptarmigan">nayutaco/ptarmigan</a> - 符合C ++ BOLT標準的Lightning網路實現[Incomplete]</li>
  <li><a href="https://github.com/LightningPeach/lpd">LightningPeach/lpd</a> - 是Rust語言中Lightning Network節點的部分實現。</li>
  <li><a href="https://github.com/rust-bitcoin/rust-lightning">rust-bitcoin/rust-lightning</a> - 用rust程式語言實現，完成度20%</li>
</ul>

<p><strong>錢包 (在地/遠端, 全/剪裁/輕節點, 直接/網站交互)</strong></p>
<ul>
  <li>中心化錢包</li>
  <li>去中心化錢包</li>
</ul>

<p><strong>偵防塔</strong>
<strong>聊天</strong>
<strong>選擇性支援</strong></p>
<ul>
  <li>HD wallet</li>
  <li>tor <a href="https://github.com/lightningnetwork/lightning-onion">lightning-onion</a></li>
  <li>剪裁
    <h2 id="9-閃電網路狀態">9. 閃電網路狀態</h2>
  </li>
  <li>閃電網路瀏覽器
    <ul>
      <li><a href="https://1ml.com/node/0395033b252c6f40e3756984162d68174e2bd8060a129c0d3462a9370471c6d28f">1ML</a></li>
    </ul>
  </li>
  <li>其他
    <ul>
      <li>liquid network</li>
    </ul>
  </li>
</ul>

<p><img src="https://i.imgur.com/8hgSLLb.png" alt="" /></p>

<h1 id="cypherpunks-core">Cypherpunks Core</h1>
<ul>
  <li><a href="https://github.com/cypherpunks-core/Lightning_network_resources_zh">閃電網路資源整理</a></li>
  <li><a href="https://cypherpunks-core.github.io/bitcoinbook_2nd_zh/%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A0.html">精通位元幣-第十二章 區塊鏈應用</a></li>
  <li><a href="https://cypherpunks-core.github.io/bitcoinbook_2nd_zh/%E7%AC%AC%E4%B8%83%E7%AB%A0.html">精通位元幣-第七章 高級交易腳本</a></li>
</ul>

<h2 id="rusty-russells-coding-blog--oldnew">Rusty Russell’s Coding Blog  <a href="https://rusty.ozlabs.org/">old</a>、<a href="https://medium.com/@rusty_lightning">new</a></h2>
<ul>
  <li><a href="https://rusty.ozlabs.org/?p=450">Part I: Revocable Transactions</a></li>
  <li><a href="https://rusty.ozlabs.org/?p=462">Part II: Hashed Timelock Contracts (HTLCs)</a></li>
  <li><a href="https://rusty.ozlabs.org/?p=467">Part III: Channeling Contracts</a></li>
  <li><a href="https://rusty.ozlabs.org/?p=477">Part IV: Summary</a></li>
</ul>

<h2 id="bitmex-research">Bitmex Research</h2>
<ul>
  <li><a href="https://blog.bitmex.com/zh_cn-the-lightning-network/">閃電網路（第 1 部分）</a>
    <ul>
      <li>路由問題
        <ul>
          <li>交易可能存在延遲</li>
        </ul>
      </li>
      <li>押金問題
        <ul>
          <li>auto pilot 演算法(30%使用)</li>
        </ul>
      </li>
      <li>大hub 中心化問題</li>
      <li>雙方在線問題</li>
      <li>偵防塔問題</li>
    </ul>
  </li>
  <li><a href="https://blog.bitmex.com/zh_cn-the-lightning-network-part-2-routing-fee-economics/">閃電網路（第 2 部分）— 路由費經濟學</a>
    <ul>
      <li>手續費問題
        <ul>
          <li>固定手續費</li>
          <li>幾趴手續費</li>
        </ul>
      </li>
      <li>押金問題
        <ul>
          <li>百姓-平臺之間的博弈
  <img src="https://i.imgur.com/yIwISLd.png" alt="" /></li>
          <li>運行節點的代價
  <strong>誰可以解決押金問題，就可以掙錢</strong></li>
          <li>手續費、押金、跟誰建立
  <strong>手續費 vs 交易量</strong>
  <img src="https://i.imgur.com/5d9kzuE.png" alt="" />
  <strong>不同交易手續費年畫</strong>
  <img src="https://i.imgur.com/FOW6EJ1.png" alt="" /></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="https://blog.bitmex.com/zh_cn-lightning-network-justice/">閃電網路 (第 3 部分) — 正義在何處？</a>
    <ul>
      <li>作惡的逞罰機製</li>
      <li>開通道的隻有一種，關通道的有四種
        <ul>
          <li>雙方一起</li>
          <li>單方關閉通道
            <ul>
              <li>單方關閉 - 正常</li>
              <li>單方關閉 - 違規
                <ul>
                  <li>被製裁</li>
                  <li>沒被製裁
  <img src="https://i.imgur.com/1ZtCEFq.png" alt="" /></li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>正義的次數
  <img src="https://i.imgur.com/lPztVpp.png" alt="" /></li>
      <li>正義的金額
  <img src="https://i.imgur.com/moOEdcL.png" alt="" /></li>
    </ul>
  </li>
  <li><a href="https://blog.bitmex.com/zh_cn-lightning-network-part-4-all-adopt-the-watchtower/">閃電網路（第 4 部分） – 全麵採取瞭望塔功能</a>
  偵防塔的功能觸發
  <img src="https://i.imgur.com/EhI94Nd.jpg" alt="" />
  最重要：要能夠好好備份，在過去的偵防塔可能會導緻閃電網路內存崩潰，街覺方案<a href="https://wiki.ion.radar.tech/tutorials/troubleshooting/static-channel-backups">Static Channel Backup</a>
    <ul>
      <li>待解決的問題：
        <ul>
          <li>穩定性</li>
          <li>安全性</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="https://blog.bitmex.com/zh_cn-lightning-network-part-5-bitmex-research-launches-penalty-transaction-alert-system/">閃電網路（第 5 部分）– BitMEX 研究推出懲罰交易警報係統</a>
    <ul>
      <li>Bitmex 正義交易列錶 <a href="https://forkmonitor.info/lightning">link</a></li>
      <li>特色： 目前所有的正義出現 跟交易手續費沒有正相關</li>
    </ul>
  </li>
</ul>

<h2 id="ethfans---狀態通道">EthFans - <a href="https://ethfans.org/post_tags/%E7%8A%B6%E6%80%81%E9%80%9A%E9%81%93">狀態通道</a></h2>

<p><strong>閃電網路當前的主要局限</strong></p>

<ul>
  <li><a href="https://ethfans.org/posts/major--limitations-of-the-lightning-network-part-1">閃電網路當前的主要局限，Part-1</a></li>
  <li><a href="https://ethfans.org/posts/major--limitations-of-the-lightning-network-part-2">閃電網路當前的主要局限，Part-2</a></li>
</ul>

<p><strong>閃電 VS 雷電：瞭望塔模式</strong></p>

<ul>
  <li><a href="https://ethfans.org/posts/lightning-vs-raiden-watchtowers-monitoring-services-differences">閃電 vs. 雷電：瞭望塔可拓展嗎? （上）：模式及營運成本</a></li>
  <li><a href="https://ethfans.org/posts/lightning-vs-raiden-watchtowers-monitoring-services-solutions-privacy-and-scalability">閃電 VS 雷電：瞭望塔模式（中）：瞭望塔中的隱私保護與可擴展性</a></li>
  <li><a href="https://ethfans.org/posts/lightning-vs-raiden-watchtowers-accountability-business-models-celer-pisa">閃電 VS 雷電：瞭望塔模式（下）：可追責性與商業模式</a></li>
</ul>

<p><strong>菜鳥</strong></p>

<ul>
  <li><a href="https://ethfans.org/posts/counterfactual-for-dummies-part-1">Part-1：支付通道</a></li>
  <li><a href="https://ethfans.org/posts/state-channel-for-dummies-part-2">Part-2：App 定製型狀態通道</a></li>
  <li><a href="https://ethfans.org/posts/state-channels-for-dummies-part-3">Part-3：多跳交易/中心輻射通道</a></li>
  <li><a href="https://ethfans.org/posts/state-channel-for-dummies-part-4">Part-4：賬本通道和虛擬通道</a></li>
  <li><a href="https://ethfans.org/posts/state-channels-for-dummies-part-5">Part-5：廣義狀態通道</a></li>
</ul>

<p><strong>其他</strong></p>

<ul>
  <li><a href="https://ethfans.org/posts/lightning-network-routing-privacy-and-efficiency-in-a-positive-sum-game">閃電網路路由：正和博弈中的隱私和效率問題</a></li>
  <li><a href="https://ethfans.org/posts/when-lightning-starks">StarksPay：當閃電網路遇上 STARKs</a></li>
  <li><a href="https://ethfans.org/posts/lighting-network-is-bitcoins-tcp-ip">閃電網路是位元幣的 TCP/IP 協議棧</a></li>
  <li><a href="https://ethfans.org/topics/197">閃電網路非常不錯，但它存在各種各樣的問題</a></li>
  <li><a href="https://ethfans.org/posts/state-channel-applications">標準化狀態通道的架構與 Counterfactual</a></li>
  <li><a href="https://ethfans.org/posts/dynamic-mediation-fees-in-raiden-explained">雷電網路的動態調解費用</a></li>
  <li><a href="https://ethfans.org/posts/ethereum-lightning-network-and-beyond">閃電網路與以太坊結合建立支付通路的構想及其願景</a></li>
</ul>

<h2 id="bitcoinmagazine">BitcoinMagazine</h2>
<p><strong>Understanding the Lightning Network</strong></p>

<ul>
  <li><a href="https://bitcoinmagazine.com/articles/understanding-the-lightning-network-part-building-a-bidirectional-payment-channel-1464710791">Part 1: Building a Bidirectional Bitcoin Payment Channel</a></li>
  <li><a href="https://bitcoinmagazine.com/articles/understanding-the-lightning-network-part-creating-the-network-1465326903">Part 2: Creating the Network</a></li>
  <li><a href="https://bitcoinmagazine.com/articles/understanding-the-lightning-network-part-completing-the-puzzle-and-closing-the-channel-1466178980">Part 3: Completing the Puzzle and Closing the Channel</a></li>
</ul>

<h2 id="csdn">CSDN</h2>
<ul>
  <li><a href="https://blog.csdn.net/chunlongyu/article/details/80320696">第12課 nLockTime(CLTV)與Sequence number(CSV)</a></li>
  <li><a href="https://blog.csdn.net/weixin_41958153/article/details/84307939">第13課 微支付通道（MicroPayment Channel) – 迄今為止最透徹的講解了</a></li>
  <li><a href="https://blog.csdn.net/chunlongyu/article/details/80354563">第14課 閃電網路(Lightning Network) 之 RSMC</a></li>
  <li><a href="https://blog.csdn.net/chunlongyu/article/details/80354603">第15課 閃電網路之 Script Language與Script Engine</a></li>
  <li><a href="https://blog.csdn.net/chunlongyu/article/details/80417309">第16課 閃電網路(Lightning Network) 之 HTLC</a></li>
  <li><a href="https://blog.csdn.net/chunlongyu/article/details/80417356">第17課 交易延展性（Malleability）攻擊 – 門頭溝（前世界第1大位元幣交易所）倒閉之罪魁禍首</a></li>
</ul>

<h2 id="living-a-simple-life-is-a-happy-life">Living a Simple Life is a Happy Life</h2>
<ul>
  <li><a href="https://happy123.me/blog/2019/01/06/bi-te-bi-de-jiao-yi-7/">Hello Lightning Network -0</a></li>
  <li><a href="https://happy123.me/blog/2019/11/05/hello-lightning-network-1/">Hello Lightning Network -1</a></li>
  <li><a href="https://happy123.me/blog/2019/11/26/hello-lightning-network-2/">Hello Lightning Network -2</a></li>
  <li><a href="https://happy123.me/blog/2019/11/30/hello-lightning-network-3/">Hello Lightning Network -3</a></li>
  <li><a href="https://happy123.me/blog/2019/05/21/shan-dian-wang-luo-man-man-cheng-chang/">閃電網路慢慢成長</a></li>
  <li><a href="https://happy123.me/blog/2019/11/18/setup-lightning-node-cheat-sheet/">Setup Lightning Node Cheat Sheet</a></li>
  <li><a href="https://happy123.me/blog/2019/09/13/eltoo-shan-dian-he-chi-xian-qi-yue-geng-xin-ji-zhi/">Eltoo-閃電和離線契約更新機製</a></li>
</ul>

<h2 id="問題-1">問題</h2>
<ul>
  <li>閃電網路通道 是2-of-2 交易，那要收取手續費，最後一筆支出會是三個人收到錢？</li>
  <li>正義交易權力太大，為什麼可以轉走所有的錢。是否存在可以陷害人</li>
  <li>閃電網路上 實現智能合約</li>
</ul>

  </div>

  <div class="date">
    Written on October 10, 2020
  </div>
  
  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:cov2019@protonmail.com"><i class="svg-icon email"></i></a>
<a href="https://www.facebook.com/dogewwoww"><i class="svg-icon facebook"></i></a>

<a href="https://github.com/awesome-doge"><i class="svg-icon github"></i></a>








        </footer>
      </div>
    </div>

    
	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-131051587-4', 'auto');
		ga('send', 'pageview', {
		  'page': '/%E9%96%83%E9%9B%BB%E7%B6%B2%E8%B7%AF%E7%AD%86%E8%A8%98/',
		  'title': '閃電網路筆記'
		});
	</script>
	<!-- End Google Analytics -->


  </body>
</html>
